import pandas as pd\nfrom datetime import datetime\nimport os\nfrom typing import List, Dict, Any\n\nclass ExcelExporter:\n    \"\"\"\n    Excel文件导出工具类\n    用于将爬取结果保存到Excel文件\n    \"\"\"\n    \n    def __init__(self, output_dir: str = \"exports\"):\n        self.output_dir = output_dir\n        # 确保输出目录存在\n        os.makedirs(output_dir, exist_ok=True)\n    \n    def export_crawl_results(self, results: List[Dict[str, Any]], filename: str = None, keyword: str = None) -> str:\n        \"\"\"\n        将爬取结果导出到Excel文件\n        \n        Args:\n            results: 爬取结果列表\n            filename: 输出文件名，如果不提供则自动生成\n            keyword: 关键词，用于生成文件名\n        \n        Returns:\n            导出文件的路径\n        \"\"\"\n        if not results:\n            raise ValueError(\"没有数据可导出\")\n        \n        # 如果没有提供文件名，则生成一个\n        if not filename:\n            timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n            keyword_part = f\"_{keyword}\" if keyword else \"\"\n            filename = f\"crawl_results{keyword_part}_{timestamp}.xlsx\"\n        \n        # 确保文件名安全\n        filename = self._sanitize_filename(filename)\n        filepath = os.path.join(self.output_dir, filename)\n        \n        # 准备数据\n        df_data = []\n        for result in results:\n            df_data.append({\n                '标题': result.get('title', '')[:500],  # 限制长度\n                '网址': result.get('url', ''),\n                '发布时间': result.get('published_at', ''),\n                '抓取时间': result.get('crawled_at', ''),\n                '关键词': result.get('keyword_matched', ''),\n                '内容摘要': result.get('summary', '')[:200],  # 限制长度\n                '完整内容': result.get('content', '')[:1000]  # 限制长度\n            })\n        \n        # 创建DataFrame\n        df = pd.DataFrame(df_data)\n        \n        # 保存到Excel文件\n        with pd.ExcelWriter(filepath, engine='openpyxl') as writer:\n            df.to_excel(writer, sheet_name='爬取结果', index=False)\n            \n            # 获取工作表对象以调整列宽\n            worksheet = writer.sheets['爬取结果']\n            \n            # 自动调整列宽\n            for column in worksheet.columns:\n                max_length = 0\n                column_letter = column[0].column_letter\n                \n                for cell in column:\n                    try:\n                        if len(str(cell.value)) > max_length:\n                            max_length = len(str(cell.value))\n                    except:\n                        pass\n                \n                adjusted_width = min(max_length + 2, 50)  # 限制最大宽度\n                worksheet.column_dimensions[column_letter].width = adjusted_width\n        \n        return filepath\n    \n    def export_multiple_keywords_results(self, results_by_keyword: Dict[str, List[Dict[str, Any]]], base_filename: str = \"crawl_results\") -> List[str]:\n        \"\"\"\n        将多个关键词的结果分别导出到不同的Excel文件\n        \n        Args:\n            results_by_keyword: 按关键词分组的结果字典\n            base_filename: 基础文件名\n        \n        Returns:\n            导出文件路径列表\n        \"\"\"\n        exported_files = []\n        \n        for keyword, results in results_by_keyword.items():\n            if results:  # 只有当结果不为空时才导出\n                filename = f\"{base_filename}_{keyword}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx\"\n                filepath = self.export_crawl_results(results, filename, keyword)\n                exported_files.append(filepath)\n        \n        return exported_files\n    \n    def _sanitize_filename(self, filename: str) -> str:\n        \"\"\"\n        清理文件名，移除不安全字符\n        \"\"\"\n        # 替换不安全的字符\n        unsafe_chars = '<>:\"/\\\\|?*'\n        for char in unsafe_chars:\n            filename = filename.replace(char, '_')\n        \n        # 确保文件名不以空格或点开头或结尾\n        filename = filename.strip('. ')\n        \n        # 限制文件名长度\n        name, ext = os.path.splitext(filename)\n        if len(name) > 100:  # 限制文件名部分长度\n            name = name[:100]\n        if len(ext) > 10:  # 限制扩展名长度\n            ext = ext[:10]\n        \n        return name + ext\n